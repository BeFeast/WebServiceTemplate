# AGENTS.md - WebServiceTemplate

## Project Snapshot
- **Type**: Fullstack monorepo template (FastAPI + Next.js)
- **Stack**: Python 3.12 (uv), TypeScript (bun), Docker, PostgreSQL, Redis
- **Purpose**: GitHub template for DevBox-deployed web services
- **Sub-agents**: See `backend/AGENTS.md` and `frontend/AGENTS.md` for details

## Vibe Coding Slash Commands

Use these Factory CLI slash commands for rapid development:

```bash
/dev-scaffold <name>  # Create new project from template
/dev-run              # Start development servers
/dev-deploy           # Deploy Docker stack
```

## Root Setup Commands
```bash
# Initialize project from template (replaces placeholders)
./scripts/init-project.sh

# Start development (docker-compose)
make dev

# Or run separately:
make dev-backend   # FastAPI at :8000
make dev-frontend  # Next.js at :3000

# Install dependencies locally
make install
```

## Universal Conventions

### Code Style
- **Python**: Ruff formatter + linter, type hints required
- **TypeScript**: ESLint + Prettier, strict mode enabled
- **Imports**: Absolute paths (`@/` for frontend, `app.` for backend)

### Commits
- Use conventional commits: `feat:`, `fix:`, `chore:`, `docs:`
- Include ticket/issue reference when applicable

### Placeholders
Template uses `{{PLACEHOLDER}}` syntax replaced by `init-project.sh`:
- `{{PROJECT_NAME}}`, `{{PROJECT_SUBDOMAIN}}`, `{{BACKEND_PORT}}`, `{{FRONTEND_PORT}}`
- `{{SECRET_KEY}}`, `{{DB_PASS}}`, `{{REDIS_DB_NUM}}`

## Security & Secrets
- **NEVER** commit `.env` files (only `.env.example`)
- Secrets go in `.env` at project root
- Database credentials auto-generated by `init-project.sh`
- Google OAuth credentials must be manually configured

## JIT Index

### Directory Structure
```
├── backend/           → [see backend/AGENTS.md](backend/AGENTS.md)
│   ├── app/api/       # FastAPI route handlers
│   ├── app/core/      # Config, security, database
│   ├── app/models/    # SQLAlchemy models
│   ├── app/schemas/   # Pydantic schemas
│   └── app/services/  # Business logic
├── frontend/          → [see frontend/AGENTS.md](frontend/AGENTS.md)
│   ├── src/app/       # Next.js App Router pages
│   ├── src/components/# React components
│   └── src/lib/       # Utilities, API client
├── docker/            # Docker Compose files
├── scripts/           # Automation (init, deploy, db)
└── .devcontainer/     # VS Code remote development
```

### Quick Find Commands
```bash
# Find FastAPI routes
rg -n "^@router\." backend/app/api/

# Find React components
rg -n "export (function|const)" frontend/src/components/

# Find SQLAlchemy models
rg -n "class.*Base\)" backend/app/models/

# Find Pydantic schemas
rg -n "class.*BaseModel" backend/app/schemas/

# Find environment usage
rg -n "settings\." backend/app/
rg -n "process\.env\." frontend/src/
```

## Infrastructure

### DevBox Deployment
- **Development**: `/opt/projects/<project>/`
- **Production stack**: `/opt/stacks/<project>/`
- **Database**: ok-shared-infra PostgreSQL (external, not in compose)
- **Cache**: ok-shared-infra Redis (external, not in compose)
- **Network**: `ok-shared-network` (external Docker network)

### URL Routing (NPM)
Uses separate subdomains to avoid path rewriting issues:
- **Frontend**: `https://<project>.oklabs.uk` → port 3000
- **Backend API**: `https://<project>-api.oklabs.uk` → port 8000

Frontend calls backend via `NEXT_PUBLIC_API_URL` environment variable.

### Key Scripts
```bash
./scripts/init-project.sh      # Initialize from template
./scripts/create-project-db.sh # Create DB in shared PostgreSQL
./scripts/setup-npm-hosts.sh   # Create NPM proxy hosts (FE + API)
./scripts/deploy-to-devbox.sh  # Deploy via Portainer
```

## Mandatory Rules

### Bug Fix Verification (CRITICAL)
- **NEVER** claim a fix works without running tests
- **NEVER** say "try it" - test it yourself first
- **ALWAYS** show test output proving the fix works
- Run `make test` and paste results before claiming success

### Long Running Commands
Implement timeouts for commands > 30 seconds:
- Package install: 5 min timeout
- Docker build: 10 min timeout
- Tests: 15 min timeout
- Deploy: 20 min timeout

### Context Preservation
- Reference previous decisions when making new ones
- Connect new work to existing patterns
- If context lost, acknowledge and review previous work

### Documentation
- `.md` files go in `docs/` folder
- Exceptions: `README.md`, `AGENTS.md` (root level OK)

## Definition of Done
Before PR:
```bash
make lint          # Ruff + ESLint pass
make test          # pytest + Playwright pass - MUST SHOW OUTPUT
make build         # Docker images build successfully
```

**Report format:**
```
## Changes Applied: [description]

## Test Results:
[paste actual test output]

✅ All tests passing
✅ No regressions detected
```
